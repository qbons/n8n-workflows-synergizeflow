{
  "id": "gQjAGNI2eK8btFFA",
  "name": "SF - Social Media Video Combine",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "social/combine-video",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2128,
        416
      ],
      "id": "3e1af192-c037-4075-8cad-900f42081f41",
      "name": "Webhook",
      "webhookId": "40b9a849-2bbc-4be6-a8bf-f3a9b73f4eff"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "07751085-c756-4fc5-a6ab-93c8209921e9",
              "name": "audio",
              "value": "={{ $json.body.audio }}",
              "type": "string"
            },
            {
              "id": "7789cfdb-986c-421e-9642-bda65d74116f",
              "name": "subtitle",
              "value": "={{ $json.body.subtitle }}",
              "type": "string"
            },
            {
              "id": "70a3c05c-9e64-454b-baa2-d61ffc34f22f",
              "name": "video_url",
              "value": "={{ $json.body.video_url }}",
              "type": "string"
            },
            {
              "id": "573d9900-2457-431f-813e-7b3c4f227905",
              "name": "folder",
              "value": "=folder_{{ $json.body.task_id }}",
              "type": "string"
            },
            {
              "id": "ff568a00-6613-4b92-8874-45de3449303b",
              "name": "backend",
              "value": "={{ $json.body.backend }}",
              "type": "string"
            },
            {
              "id": "3fdcf8a7-bfd7-463f-9b05-d93cd2005cd8",
              "name": "token_bearer",
              "value": "={{ $json.headers.authorization }}",
              "type": "string"
            },
            {
              "id": "6c348bc5-3dd3-4278-a3bd-b10864f4c5fc",
              "name": "content_id",
              "value": "={{ $json.body.content_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1904,
        416
      ],
      "id": "249c503a-7ac6-4057-9437-aee6a01abe71",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "url": "={{ $('Edit Fields').item.json.video_url }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1456,
        416
      ],
      "id": "0784395b-b021-4f0a-ba24-fd06e2b18426",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "destinationKey": "video",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -1232,
        416
      ],
      "id": "f095ce9a-38f1-4b6b-bbcb-f2f3addc7c22",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "jsCode": "if($('Edit Fields').first().json.subtitle == 'no'){\n  return [\n    {\n      \"mime\": \"video/mp4\",\n      \"base\": $input.first().json.video,\n      \"name\": \"video.mp4\"\n    },\n    {\n      \"mime\": \"audio/mpeg\",\n      \"base\": $('Edit Fields').first().json.audio,\n      \"name\": \"audio.mp3\"\n    }\n  ]\n}else{\n  return [\n    {\n      \"mime\": \"video/mp4\",\n      \"base\": $input.first().json.video,\n      \"name\": \"video.mp4\"\n    },\n    {\n      \"mime\": \"text/plain\",\n      \"base\": $('Edit Fields').first().json.subtitle,\n      \"name\": \"subtitle.ass\"\n    },\n    {\n      \"mime\": \"audio/mpeg\",\n      \"base\": $('Edit Fields').first().json.audio,\n      \"name\": \"audio.mp3\"\n    }\n  ]  \n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1008,
        416
      ],
      "id": "083619ea-fdae-4d46-82c5-89e534ce317e",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -784,
        416
      ],
      "id": "76424d01-e692-47ab-b8ba-e849082ef666",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "490842e9-c107-4f93-8761-ee4c0f3ab650",
              "name": "mime",
              "value": "={{ $json.mime }}",
              "type": "string"
            },
            {
              "id": "98ac2ab2-bd54-4a95-ae9b-9bf9f94e3608",
              "name": "base",
              "value": "={{ $json.base }}",
              "type": "string"
            },
            {
              "id": "090e7532-8ccc-46a4-8868-22cca0239b64",
              "name": "name",
              "value": "={{ $json.name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -560,
        416
      ],
      "id": "6f12c22f-999a-4c74-9525-e756c3000961",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base",
        "options": {
          "fileName": "={{ $json.name }}",
          "mimeType": "={{ $json.mime }}"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -336,
        416
      ],
      "id": "13ffe5b3-6dc5-439f-ab58-b4464a9db830",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "operation": "write",
        "fileName": "={{ $('Edit Fields').item.json.folder }}/{{ $('Edit Fields1').item.json.name }}",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [
        -112,
        496
      ],
      "id": "884e1eae-4a81-47c4-b1cd-f665c02bedd6",
      "name": "Read/Write Files from Disk"
    },
    {
      "parameters": {
        "command": "=cd ./{{ $('Edit Fields').item.json.folder }}\nffmpeg -i video.mp4 -i audio.mp3 \\\n-filter_complex \"[0:v]split[v1][v2];[v2]reverse[v_rev];[v1][v_rev]concat=n=2:v=1:a=0[v_concat];[v_concat]loop=loop=-1:size=7500[v_out]\" \\\n-map \"[v_out]\" -map 1:a:0 \\\n-shortest -y result.mp4"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        -336,
        32
      ],
      "id": "7d9052b6-b812-4649-bced-8f37ad8b5021",
      "name": "Execute Command2"
    },
    {
      "parameters": {
        "command": "=rm -rf {{ $json.folder }}\nmkdir -p {{ $json.folder }}"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        -1680,
        416
      ],
      "id": "5e26b4e5-ad8b-49eb-b4a1-319cb8d3e117",
      "name": "Execute Command3"
    },
    {
      "parameters": {
        "fileSelector": "=./{{ $('Edit Fields').item.json.folder }}/result.mp4",
        "options": {
          "fileName": "result.mp4"
        }
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [
        -112,
        128
      ],
      "id": "ea43701e-2410-4f00-8699-839f0163974e",
      "name": "Read/Write Files from Disk1"
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        112,
        128
      ],
      "id": "de97adfc-5b8d-4946-947b-d349ae6443ad",
      "name": "Extract from File1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ce8cc53-0c80-475d-8c5b-f2eaffedb984",
              "name": "base",
              "value": "=data:video/mp4;base64,{{ $json.data }}",
              "type": "string"
            },
            {
              "id": "58dfc8e1-0384-4552-934c-be70bc7e2e95",
              "name": "mime",
              "value": "video/mp4",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        336,
        128
      ],
      "id": "65bc8653-82ed-4f13-b7ee-7db2412dbdfe",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        560,
        624
      ],
      "id": "3bacbf7c-ab84-4fc6-9722-7073129cc770",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "command": "=rm -rf {{ $('Edit Fields').item.json.folder }}"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        784,
        128
      ],
      "id": "a7ca6ef5-57a5-4eab-9131-ea42f95429d0",
      "name": "Execute Command"
    },
    {
      "parameters": {
        "command": "=cd ./{{ $('Edit Fields').item.json.folder }}\nffmpeg -i video.mp4 -i audio.mp3 -i subtitle.ass \\\n-filter_complex \"[0:v]split[v1][v2];[v2]reverse[v_rev];[v1][v_rev]concat=n=2:v=1:a=0[v_concat];[v_concat]loop=loop=-1:size=7500[v_looped];[v_looped]ass=filename=subtitle.ass[v_out]\" \\\n-map \"[v_out]\" -map 1:a:0 \\\n-shortest -y result.mp4"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        -336,
        224
      ],
      "id": "e6d2b17b-23da-469c-930b-0170233b2f8f",
      "name": "Execute Command4"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Edit Fields').item.json.subtitle }}",
                    "rightValue": "no",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "d7e0ace3-a7bc-4f17-8758-f4a610abec29"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "no_sub"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9b406d0a-12ee-473a-83a4-38ed3859e5e5",
                    "leftValue": "={{ $('Edit Fields').item.json.subtitle }}",
                    "rightValue": "no",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "has_sub"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -560,
        128
      ],
      "id": "7cfb4d0d-d524-4e25-b383-c8bb26726fd6",
      "name": "Switch"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Edit Fields').item.json.backend }}/api/social-agent/finish",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('Edit Fields').item.json.token_bearer }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "base",
              "value": "={{ $json.base }}"
            },
            {
              "name": "mime",
              "value": "={{ $json.mime }}"
            },
            {
              "name": "content_id",
              "value": "={{ $('Edit Fields').item.json.content_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        544,
        128
      ],
      "id": "1698e8ea-4354-4546-a6d6-85b6f9a6882e",
      "name": "HTTP Request1"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Execute Command3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Read/Write Files from Disk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read/Write Files from Disk": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Command2": {
      "main": [
        [
          {
            "node": "Read/Write Files from Disk1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Command3": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read/Write Files from Disk1": {
      "main": [
        [
          {
            "node": "Extract from File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File1": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond to Webhook": {
      "main": [
        []
      ]
    },
    "Execute Command4": {
      "main": [
        [
          {
            "node": "Read/Write Files from Disk1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Execute Command2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute Command4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Execute Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "FfOIxnXYC00WoM2o"
  },
  "triggerCount": 1,
  "versionId": "97ae6fcb-8343-4099-938d-8d35980e8280",
  "owner": {
    "type": "personal",
    "projectId": "ZvP1yE48ZEo7zgpC",
    "projectName": "Synergize Flow Team <info@mantab.one>",
    "personalEmail": "info@mantab.one"
  },
  "parentFolderId": "W6kfCfNZPfSqIn2i",
  "isArchived": false
}